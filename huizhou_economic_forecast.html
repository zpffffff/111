<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº¤é€šäº‹æ•…ç»æµæŸå¤±é¢„æµ‹</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <style>
        #forecast-chart {
            width: 100%;
            height: 600px;
        }
        .nav-link {
            text-align: center;
            margin: 20px;
        }
        a {
            color: #4ECDC4;
            text-decoration: none;
            font-size: 16px;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <h2>æƒ å·å¸‚äº¤é€šäº‹æ•…ç»æµæŸå¤±é¢„æµ‹ï¼ˆ2016-2030ï¼‰</h2>
    <div class="nav-link">
        <a href="main_chart.html">ğŸ‘‰ æŸ¥çœ‹è¶‹åŠ¿åˆ†æ</a>
        <a href="pie_chart.html">ğŸ‘‰ æŸ¥çœ‹å æ¯”åˆ†æ</a>
        <a href="huizhou_forecast.html">ğŸ‘‰ æŸ¥çœ‹æ­»äº¡äººæ•°é¢„æµ‹</a>
    </div>
    <div id="forecast-chart"></div>

    <script>
        Promise.all([
            fetch('http://127.0.0.1:8004/api/traffic-history').then(res => res.json()),
            fetch('http://127.0.0.1:8004/api/traffic-forecast').then(res => res.json())
        ]).then(([historyResponse, forecastResponse]) => {
            // æå–å†å²æ•°æ®å’Œé¢„æµ‹æ•°æ®
            const historyData = historyResponse.data;  // å†å²æ•°æ®
            const forecastData = forecastResponse.forecast;  // é¢„æµ‹æ•°æ®

            // è¿‡æ»¤é¢„æµ‹æ•°æ®ï¼ˆç¡®ä¿åªä¿ç•™2025-2030ï¼‰
            const filteredForecastData = forecastData.filter(d => d.å¹´ä»½ >= 2025);

            // åˆå¹¶æ•°æ®å¹¶æ’åº
            let allData = [...historyData, ...filteredForecastData];
            allData.sort((a, b) => a.å¹´ä»½ - b.å¹´ä»½);

            // æå–æ•°æ®æ—¶æ˜ç¡®å­—æ®µå
            const allYears = allData.map(d => d.å¹´ä»½);
            const allEconomic = allData.map(d =>
                d['å…¨å¸‚æŸå¤±æŠ˜æ¬¾'] !== undefined ? d['å…¨å¸‚æŸå¤±æŠ˜æ¬¾'] : d['é¢„æµ‹æŸå¤±æŠ˜æ¬¾'] // æ ¹æ®å­—æ®µåè°ƒæ•´
            );

            const historyValues = historyData.map(d => d['å…¨å¸‚æŸå¤±æŠ˜æ¬¾']);
            const forecastValues = filteredForecastData.map(d => d['é¢„æµ‹æŸå¤±æŠ˜æ¬¾']);

            // åˆå§‹åŒ–å›¾è¡¨
            const chartElement = document.getElementById("forecast-chart");
            const chart = echarts.init(chartElement);
            console.log("ğŸ¯ ECharts åˆå§‹åŒ–æˆåŠŸï¼");

            const option = {
                tooltip: { trigger: 'axis' },
                legend: {
                    data: ['å†å²æŸå¤±', 'é¢„æµ‹æŸå¤±'],
                    selected: {
                        'é¢„æµ‹æŸå¤±': false  // åˆå§‹æ—¶éšè—é¢„æµ‹æŸå¤±
                    }
                },
                xAxis: {
                    type: 'category',
                    data: allYears,
                    axisLabel: { rotate: 45 }
                },
                yAxis: { name: 'ç»æµæŸå¤±ï¼ˆä¸‡å…ƒï¼‰' },
                series: [
                    {
                        name: 'å†å²æŸå¤±',
                        type: 'line',
                        data: allEconomic.slice(0, historyData.length),
                        itemStyle: { color: '#6C5B7B' },
                        lineStyle: { width: 2 }
                    },
                    {
                        name: 'é¢„æµ‹æŸå¤±',
                        type: 'line',
                        data: allEconomic.slice(historyValues),  // é¢„æµ‹æ•°æ®
                        itemStyle: { color: '#E84A5F' },
                        lineStyle: { type: 'dashed', width: 2, opacity: 0 },  // åˆå§‹æ—¶éšè—
                        symbol: 'triangle',
                        symbolSize: 10
                    }
                ]
            };

            chart.setOption(option);

            // ç›‘å¬ legendselectchanged äº‹ä»¶
            chart.on('legendselectchanged', function (params) {
                if (params.name === 'é¢„æµ‹æŸå¤±') {
                    const isSelected = params.selected['é¢„æµ‹æŸå¤±'];
                    const series = option.series;
                    series[1].lineStyle.opacity = isSelected ? 1 : 0;  // æ˜¾ç¤ºæˆ–éšè—é¢„æµ‹æŸå¤±
                    chart.setOption({ series: series });
                }
            });

            window.addEventListener('resize', () => chart.resize());
        }).catch(error => {
            console.error("âŒ æ•°æ®åŠ è½½å¤±è´¥:", error);
        });
    </script>
</body>
</html>